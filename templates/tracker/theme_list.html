{% extends "base.html" %}

{% block content %}
<div class="container">
  <h2 class="my-4">
    {% if category %}
      <i class="fas fa-tag me-2"></i>Threat: {{ category.name }}
    {% else %}
      <i class="fas fa-list-ul me-2"></i>All Threat
    {% endif %}
  </h2>

  <div class="card border-0 shadow-sm">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Threat List</h5>
        <a href="{% url 'add_theme' %}{% if category %}?category={{ category.id }}{% endif %}" class="btn btn-light btn-sm">
          <i class="fas fa-plus me-1"></i> Add Threat
        </a>
      </div>
    </div>

    <div class="card-body">
      <div class="row g-2 align-items-center mb-3">
        <div class="col-md-6">
          <div class="input-group">
            <input
              type="text"
              id="searchInput"
              class="form-control"
              placeholder="Search Threat..."
              value="{{ request.GET.q }}">
            <button type="button" class="btn btn-outline-secondary" id="searchButton">
              <i id="searchIcon" class="fas fa-search"></i>
              <span id="searchSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="col-md-6 text-md-end">
          <div class="btn-group btn-group-sm" role="group" aria-label="Sort by hidden date">
            <button class="btn btn-outline-secondary" id="btnNewest" type="button">
              <i class="fa-solid fa-arrow-down-1-9 me-1"></i> Newest
            </button>
            <button class="btn btn-outline-secondary" id="btnOldest" type="button">
              <i class="fa-solid fa-arrow-up-1-9 me-1"></i> Oldest
            </button>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table id="themeTable" class="table table-hover align-middle w-100">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Category</th>
              <th>Risk</th>
              <th>Onset timeline</th>
              <th style="width:160px;">Actions</th>
              <th class="d-none">_ts</th> {# timestamp oculto para ordenar por fecha #}
            </tr>
          </thead>
          <tbody>
            {% for theme in themes %}
            <tr>
              <td>
                <a href="{% url 'view_theme' pk=theme.id %}" class="text-decoration-none">{{ theme.name }}</a>
              </td>
              <td>{{ theme.category.name }}</td>

              {# Orden semántico de Risk: usa data-order con risk_order y muestra el badge #}
              <td data-order="{{ theme.risk_order|default:999 }}">
                <span class="badge bg-{{ theme.get_risk_color }}">{{ theme.get_risk_rating_display }}</span>
              </td>

              {# Orden semántico de Onset: usa data-order con onset_order y muestra texto #}
              <td data-order="{{ theme.onset_order|default:999 }}">
                {{ theme.get_onset_timeline_display }}
              </td>

              <td>
                <div class="btn-group btn-group-sm">
                  <a href="{% url 'edit_theme' theme.id %}" class="btn btn-outline-warning" title="Edit">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="{% url 'add_event' theme.id %}" class="btn btn-outline-primary" title="Add Event">
                    <i class="fas fa-plus"></i> Event
                  </a>
                </div>
              </td>

              {# Epoch del último Event/Source (oculto) #}
              <td class="d-none">{{ theme.sort_date|date:'U'|default:'-1' }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center py-4">
                No Threat found.
                <a href="{% url 'add_theme' %}{% if category %}?category={{ category.id }}{% endif %}" class="ms-2">Create one?</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{# Incluimos DataTables (CSS/JS) directamente aquí para asegurar carga #}
<link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-1.13.8/datatables.min.css">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/v/bs5/dt-1.13.8/datatables.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const searchInput   = document.getElementById('searchInput');
  const searchButton  = document.getElementById('searchButton');
  const searchIcon    = document.getElementById('searchIcon');
  const searchSpinner = document.getElementById('searchSpinner');

  // Índices de columnas:
  // 0: Name, 1: Category, 2: Risk(data-order), 3: Onset(data-order), 4: Actions, 5: _ts (oculta)
  const COL_TS      = 5;
  const COL_ACTIONS = 4;

  const table = $('#themeTable').DataTable({
    paging: true,
    pageLength: 25,
    lengthMenu: [10, 25, 50, 100],
    order: [[COL_TS, 'desc']],   // default: más recientes primero
    columnDefs: [
      { targets: [COL_ACTIONS], orderable: false, searchable: false },
      { targets: [COL_TS], visible: false, searchable: false } // columna timestamp oculta
    ],
    language: {
      search: "Filter:",
      lengthMenu: "Show _MENU_",
      info: "Showing _START_ to _END_ of _TOTAL_ items",
      infoEmpty: "No items",
      infoFiltered: "(filtered from _MAX_ total)",
      zeroRecords: "No matching items found",
      paginate: { first: "First", last: "Last", next: "Next", previous: "Prev" }
    }
  });

  function showLoading(show) {
    if (!searchIcon || !searchSpinner) return;
    if (show) {
      searchIcon.classList.add('d-none');
      searchSpinner.classList.remove('d-none');
    } else {
      searchIcon.classList.remove('d-none');
      searchSpinner.classList.add('d-none');
    }
  }

  function performSearch() {
    showLoading(true);
    const val = (searchInput && searchInput.value) ? searchInput.value : '';
    table.search(val).draw();
    showLoading(false);
  }

  // Búsqueda instantánea con un debounce corto
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      clearTimeout(searchInput._t);
      searchInput._t = setTimeout(performSearch, 120);
    });
  }
  if (searchButton) {
    searchButton.addEventListener('click', (e) => { e.preventDefault(); performSearch(); });
  }

  // Botones de orden por fecha oculta
  const btnNewest = document.getElementById('btnNewest');
  const btnOldest = document.getElementById('btnOldest');
  if (btnNewest) btnNewest.addEventListener('click', () => table.order([COL_TS, 'desc']).draw());
  if (btnOldest) btnOldest.addEventListener('click', () => table.order([COL_TS, 'asc']).draw());

  // Si venía ?q= en la URL, aplicarlo de entrada
  const params = new URLSearchParams(window.location.search);
  const initialQ = params.get('q') || '';
  if (initialQ && searchInput) {
    searchInput.value = initialQ;
    table.search(initialQ).draw();
  }
});
</script>
