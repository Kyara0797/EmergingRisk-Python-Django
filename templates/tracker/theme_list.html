{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Dynamic title -->
    <h2 class="my-4">
        {% if category %}
        <i class="fas fa-tag me-2"></i>Threat: {{ category.name }}
        {% else %}
        <i class="fas fa-list-ul me-2"></i>All Threats
        {% endif %}
    </h2>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Threat List</h5>
                <a href="{% url 'add_theme' %}{% if category %}?category={{ category.id }}{% endif %}" class="btn btn-light btn-sm">
                    <i class="fas fa-plus me-1"></i> Add Threat
                </a>
            </div>
        </div>

        <div class="card-body">
            <!-- Usamos el buscador nativo de DataTables -->
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="themesTable" style="width:100%;">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th class="no-sort">Category</th>
                            <th>Onset</th>
                            <th>Risk</th>
                            <th class="no-sort" style="width:160px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for theme in themes %}
                        <tr class="theme-item" data-href="{% url 'view_theme' pk=theme.id %}">
                            <!-- NAME (ordenable) -->
                            <td>
                                <a href="{% url 'view_theme' pk=theme.id %}" class="text-decoration-none">
                                    {{ theme.name }}
                                </a>
                            </td>

                            <!-- CATEGORY (NO ordenable) -->
                            <td>{{ theme.category.name }}</td>

                            <!-- ONSET (orden por el texto mostrado) -->
                            <td>
                                {{ theme.get_onset_timeline_display }}
                            </td>

                            <!-- RISK (orden por el texto mostrado) -->
                            <td>
                                <span class="badge bg-{{ theme.get_risk_color }}">
                                    {{ theme.get_risk_rating_display }}
                                </span>
                            </td>

                            <!-- ACTIONS (NO ordenable) -->
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'edit_theme' theme.id %}" class="btn btn-outline-warning" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{% url 'add_event' theme.id %}" class="btn btn-outline-primary" title="Add Event">
                                        <i class="fas fa-plus"></i> Event
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                No Threat found.
                                <a href="{% url 'add_theme' %}{% if category %}?category={{ category.id }}{% endif %}" class="ms-2">Create one?</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {# Si sólo usarás DataTables, puedes quitar esta paginación del servidor #}
        {% if is_paginated %}
        <div class="card-footer bg-white">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                            Previous
                        </a>
                    </li>
                    {% endif %}
                    {% for num in page_obj.paginator.page_range %}
                    <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                        <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                            {{ num }}
                        </a>
                    </li>
                    {% endfor %}
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                            Next
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Oculta flechas de sort en columnas sin orden (Category, Actions) y desactiva clic */
#themesTable th.no-sort.sorting:before,
#themesTable th.no-sort.sorting:after,
#themesTable th.no-sort.sorting_asc:before,
#themesTable th.no-sort.sorting_asc:after,
#themesTable th.no-sort.sorting_desc:before,
#themesTable th.no-sort.sorting_desc:after,
#themesTable th.no-sort.sorting_disabled:before,
#themesTable th.no-sort.sorting_disabled:after {
  display: none !important;
}
#themesTable th.no-sort { pointer-events: none; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // helper para extraer texto plano de una celda HTML (sirve para ordenar por el texto visible)
  function plainText(data) {
    const div = document.createElement('div');
    div.innerHTML = data == null ? '' : data;
    return (div.textContent || div.innerText || '').trim();
  }

  const dt = $('#themesTable').DataTable({
    autoWidth: false,
    ordering: true,
    order: [],            // sin orden inicial forzado
    pageLength: 10,
    // Name, Onset y Risk ordenables; Category y Actions NO.
    columnDefs: [
      // 0 Name: ordenable por defecto
      { targets: 0, orderable: true },

      // 1 Category: NO ordenable
      { targets: 1, orderable: false, className: 'no-sort' },

      // 2 Onset: ordenar por el TEXTO visible
      {
        targets: 2,
        orderable: true,
        render: function (data, type) {
          if (type === 'sort' || type === 'type') return plainText(data);
          return data;
        }
      },

      // 3 Risk: ordenar por el TEXTO visible dentro del badge
      {
        targets: 3,
        orderable: true,
        render: function (data, type) {
          if (type === 'sort' || type === 'type') return plainText(data);
          return data;
        }
      },

      // 4 Actions: NO ordenable ni searchable + clase para ocultar flechas
      { targets: 4, orderable: false, searchable: false, className: 'no-sort' }
    ],
    language: {
      search: "Search:",
      lengthMenu: "Show _MENU_",
      info: "Showing _START_ to _END_ of _TOTAL_ threats",
      infoEmpty: "Showing 0 to 0 of 0 threats",
      emptyTable: "No threats available",
      paginate: { first: "First", last: "Last", next: "Next", previous: "Previous" }
    }
  });

  // click en fila para ir al detalle (excepto clicks en botones/enlaces)
  $('#themesTable tbody').on('click', 'tr', function (e) {
    if ($(e.target).closest('a,button,.btn').length) return;
    const href = $(this).attr('data-href');
    if (href) window.location = href;
  });
});
</script>
{% endblock %}
