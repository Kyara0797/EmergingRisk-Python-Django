{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="card">
    <!-- Header -->
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">{{ theme.name }}</h4>

      {% if request.user.is_authenticated %}
        {% if request.user.is_staff or request.user.is_superuser %}
        <div class="d-flex gap-2 header-actions">
          <!-- Edit -->
          <a href="{% url 'edit_theme' pk=theme.pk %}" class="btn btn-warning btn-sm fw-semibold">
            <i class="fas fa-edit me-1"></i> Edit Threat
          </a>
          <!-- Add Event -->
          <a href="{% url 'add_event' theme_id=theme.id %}" class="btn btn-light btn-sm text-primary fw-semibold shadow-sm">
            <i class="fas fa-plus me-1"></i> Event
          </a>
          <!-- Archive / Restore -->
          <form method="post" action="{% url 'toggle_theme_active' pk=theme.pk %}" class="d-inline">
            {% csrf_token %}
            <button type="submit"
                    class="btn btn-outline-{{ theme.is_active|yesno:'danger,success' }} btn-sm fw-semibold"
                    onclick="return confirm('{{ theme.is_active|yesno:"Archive this threat?,Restore this threat?" }}');">
              <i class="fas fa-{{ theme.is_active|yesno:'archive,rotate-left' }} me-1"></i>
              {{ theme.is_active|yesno:'Archive,Restore' }}
            </button>
          </form>
        </div>
        {% endif %}
      {% endif %}
    </div>

    <div class="card-body">
      <!-- Theme details -->
      <div class="theme-details-container mb-4 p-3 bg-light rounded">
        <h5 class="mb-3 border-bottom pb-2">Threat Details</h5>
        <div class="row g-3">
          <div class="col-md-3">
            <div class="detail-card p-3 h-100 bg-white rounded shadow-sm">
              <div class="d-flex align-items-center mb-2">
                <i class="fas fa-folder-open text-primary me-2"></i>
                <strong class="text-muted">Category</strong>
              </div>
              <p class="mb-0 fw-bold">{{ theme.category }}</p>
            </div>
          </div>

          <div class="col-md-3">
            <div class="detail-card p-3 h-100 bg-white rounded shadow-sm">
              <div class="d-flex align-items-center mb-2">
                <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                <strong class="text-muted">Risk Rating</strong>
              </div>
              <span class="badge bg-{{ theme.get_risk_color }} p-2">
                {{ theme.get_risk_rating_display }}
              </span>
            </div>
          </div>

          <div class="col-md-3">
            <div class="detail-card p-3 h-100 bg-white rounded shadow-sm">
              <div class="d-flex align-items-center mb-2">
                <i class="fas fa-clock text-info me-2"></i>
                <strong class="text-muted">Onset Timeline</strong>
              </div>
              <p class="mb-0 fw-bold">
                {% if theme.onset_timeline %}
                  {{ theme.get_onset_timeline_display|default:theme.onset_timeline }}
                {% else %}
                  <span class="text-muted">Not specified</span>
                {% endif %}
              </p>
            </div>
          </div>

          <div class="col-md-3">
            <div class="detail-card p-3 h-100 bg-white rounded shadow-sm">
              <div class="d-flex align-items-center mb-2">
                <i class="fas fa-calendar-alt text-success me-2"></i>
                <strong class="text-muted">Events</strong>
              </div>
              <p class="mb-0 fw-bold">{{ theme.events.count }} {{ theme.events.count|pluralize:"event,events" }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Related Events -->
      <div class="mt-2">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Related Events</h5>
          <small class="text-muted">
            {{ theme.events.count }} {{ theme.events.count|pluralize:"event,events" }}
          </small>
        </div>

        {% if theme.events.count %}
          <div class="table-responsive">
            <table class="table table-hover align-middle" id="themeEventsTable">
              <thead>
                <tr>
                  <th>Event Name</th>
                  <th>Date Identified</th>
                  <th>Risk Level</th>
                  {% if request.user.is_authenticated %}
                    {% if request.user.is_staff or request.user.is_superuser %}
                      <th class="text-end no-sort">Actions</th>
                    {% endif %}
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for event in theme.events.all %}
                <tr>
                  <td>
                    <a href="{% url 'view_event' event_id=event.pk %}" class="fw-semibold">{{ event.name }}</a>
                  </td>
                  <td>{{ event.date_identified|date:"Y-m-d" }}</td>
                  <td>
                    <span class="badge bg-{{ event.get_risk_color }}">
                      {{ event.get_risk_rating_display }}
                    </span>
                  </td>
                  {% if request.user.is_authenticated %}
                    {% if request.user.is_staff or request.user.is_superuser %}
                    <td class="text-end">
                      <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
                        <!-- View -->
                        <a href="{% url 'view_event' event_id=event.pk %}" class="btn btn-outline-primary" title="View">
                          <i class="fas fa-eye"></i>
                        </a>
                        <!-- Edit -->
                        <a href="{% url 'edit_event' pk=event.pk %}" class="btn btn-outline-warning" title="Edit">
                          <i class="fas fa-edit"></i>
                        </a>
                        <!-- Archive / Restore -->
                        <form method="post" action="{% url 'toggle_event_active' pk=event.pk %}" class="d-inline">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{{ request.get_full_path }}">
                          <button type="submit"
                                  class="btn btn-outline-{{ event.is_active|yesno:'danger,success' }}"
                                  title="{{ event.is_active|yesno:'Archive,Restore' }}"
                                  onclick="return confirm('{{ event.is_active|yesno:"Archive this event?,Restore this event?" }}');">
                            <i class="fas fa-{{ event.is_active|yesno:'archive,rotate-left' }}"></i>
                          </button>
                        </form>
                      </div>
                    </td>
                    {% endif %}
                  {% endif %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-1"></i>
            No events have been added to this Threat yet.
            {% if request.user.is_authenticated %}
              {% if request.user.is_staff or request.user.is_superuser %}
                <a href="{% url 'add_event' theme_id=theme.pk %}" class="alert-link">Add the first event</a>
              {% endif %}
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
  .detail-card{transition:transform .2s ease,box-shadow .2s ease;border:1px solid rgba(0,0,0,0.05)}
  .detail-card:hover{transform:translateY(-3px);box-shadow:0 4px 8px rgba(0,0,0,0.1)!important}
  .theme-details-container{background:linear-gradient(to right,#f8f9fa,#f0f4f8)!important}
  .header-actions .btn{border-radius:.55rem}
  .header-actions .btn-light{background:#fff;border:0}
  .header-actions .btn-light:hover{background:#f8f9fa}
  /* Ocultar flechas en columnas no ordenables */
  #themeEventsTable th.no-sort.sorting:before,
  #themeEventsTable th.no-sort.sorting:after,
  #themeEventsTable th.no-sort.sorting_asc:before,
  #themeEventsTable th.no-sort.sorting_asc:after,
  #themeEventsTable th.no-sort.sorting_desc:before,
  #themeEventsTable th.no-sort.sorting_desc:after,
  #themeEventsTable th.no-sort.sorting_disabled:before,
  #themeEventsTable th.no-sort.sorting_disabled:after{display:none!important}
  #themeEventsTable th.no-sort{pointer-events:none}
</style>
{% endblock %}

{% block scripts %}
<script>
  // Booleano para DataTables
  const SHOW_EVENT_ACTIONS = {% if request.user.is_authenticated %}{% if request.user.is_staff or request.user.is_superuser %}true{% else %}false{% endif %}{% else %}false{% endif %};

  if (window.jQuery && $.fn.DataTable) {
    $(function () {
      const columnDefs = [];
      if (SHOW_EVENT_ACTIONS) {
        columnDefs.push({ targets: -1, orderable: false, searchable: false, className: 'text-end no-sort' });
      }
      $('#themeEventsTable').DataTable({
        order: [[1,'desc']],
        pageLength: 10,
        lengthMenu: [[5,10,20,-1],[5,10,20,'All']],
        columnDefs: columnDefs,
        language: {
          emptyTable: 'No events available',
          info: 'Showing _START_ to _END_ of _TOTAL_ events',
          infoEmpty: 'Showing 0 to 0 of 0 events',
          infoFiltered: '(filtered from _MAX_ total events)',
          lengthMenu: 'Show _MENU_ events',
          search: 'Search events:',
          paginate: { first: 'First', last: 'Last', next: 'Next', previous: 'Previous' }
        }
      });
    });
  }
</script>
{% endblock %}
