{% extends "base.html" %}

{% block content %}
<div class="container">
  <h2 class="my-4">Dashboard</h2>

  <!-- Categories -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Categories</h5>
        </div>
        <div class="card-body">
          <div class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-4">
            {% for category in categories %}
            <div class="col">
              <div class="card h-100 text-center border-0 shadow-sm hover-shadow transition-all">
                <div class="card-body p-3 d-flex flex-column">
                  <div class="mb-3">
                    {% if category.name == "Political" %}
                      <i class="fas fa-landmark fa-2x text-primary"></i>
                    {% elif category.name == "Economic" %}
                      <i class="fas fa-chart-line fa-2x text-success"></i>
                    {% elif category.name == "Social" %}
                      <i class="fas fa-users fa-2x text-info"></i>
                    {% elif category.name == "Technological" %}
                      <i class="fas fa-microchip fa-2x text-purple"></i>
                    {% elif category.name == "Legal" %}
                      <i class="fas fa-gavel fa-2x text-warning"></i>
                    {% elif category.name == "Environmental" %}
                      <i class="fas fa-leaf fa-2x text-success"></i>
                    {% endif %}
                  </div>
                  <h6 class="card-title mb-3 fw-bold">{{ category.name }}</h6>
                  <a href="{% url 'theme_list_by_category' category_id=category.id %}"
                     class="btn btn-sm btn-outline-primary align-self-center mt-auto py-1 px-3">
                    View Threats
                  </a>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Threats -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Recent Threats</h5>
          <a href="{% url 'theme_list_all' %}" class="btn btn-sm btn-light">View All</a>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover table-clickable table-fixed" id="themesTable">
              <thead>
                <tr>
                  <th class="col-name">Name</th>
                  <th class="col-category">Category</th>
                  <th class="col-date">Date</th>
                  <th class="col-risk">Risk</th>
                </tr>
              </thead>
              <tbody>
                {% for theme in themes %}
                <tr data-href="{% url 'theme_detail' pk=theme.id %}">
                  <td>
                    <a href="{% url 'theme_detail' pk=theme.id %}" class="truncate" title="{{ theme.name }}">
                      {{ theme.name }}
                    </a>
                  </td>
                  <td class="truncate" title="{{ theme.category }}">{{ theme.category }}</td>
                  <td class="threat-date" data-iso="{{ theme.created_at|date:'Y-m-d' }}">
                    {{ theme.created_at|date:"Y-m-d" }}
                  </td>
                  <td>
                    <span class="badge bg-{{ theme.get_risk_color }}">{{ theme.risk_rating }}</span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Events -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Recent Events</h5>
          <a href="{% url 'event_list' %}" class="btn btn-sm btn-light">View All</a>
        </div>
        <div class="card-body">

          <!-- Controles -->
          <div class="row mb-3 align-items-center">
            <div class="col-12 col-md-4 d-flex align-items-center gap-2 mb-2 mb-md-0">
              <label class="mb-0">Show</label>
              <select id="eventShowCount" class="form-select form-select-sm" style="width:auto;">
                <option value="5" selected>5</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="all">All</option>
              </select>
              <span class="text-muted small">items</span>
            </div>
            <div class="col-12 col-md-8">
              <div class="d-flex justify-content-md-end align-items-center gap-2">
                <label for="eventSearch" class="mb-0 fw-medium">Event Search:</label>
                <div class="input-group input-group-sm" style="max-width: 360px;">
                  <span class="input-group-text"><i class="fas fa-search"></i></span>
                  <input type="text" id="eventSearch" class="form-control" placeholder="Search events by name...">
                </div>
              </div>
            </div>
          </div>

          <!-- Orden -->
          <div class="row mb-3">
            <div class="col-12 text-end">
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary sort-event" data-sort="name">Name</button>
                <button type="button" class="btn btn-outline-secondary sort-event" data-sort="date">Date</button>
                <button type="button" class="btn btn-outline-secondary sort-event" data-sort="risk">Risk</button>
              </div>
            </div>
          </div>

          <!-- Lista -->
          <div class="accordion" id="eventsAccordion">
            {% for event in events %}
            <div class="accordion-item border-0 event-item"
                 data-name="{{ event.name|lower }}"
                 data-date="{{ event.date_identified|date:'Ymd' }}"
                 data-risk="{{ event.risk_rating|lower }}">
              <h2 class="accordion-header" id="heading{{ event.id }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse{{ event.id }}" aria-expanded="false"
                        aria-controls="collapse{{ event.id }}">
                  <div class="d-flex w-100 justify-content-between align-items-center">
                    <div class="me-3">
                      <strong class="event-name">{{ event.name }}</strong>
                      <div class="small text-muted event-date">{{ event.date_identified|date:"Y-m-d" }}</div>
                    </div>
                    <span class="badge bg-{{ event.get_risk_color }} me-2 event-risk">
                      {{ event.get_risk_rating_display }}
                    </span>
                  </div>
                </button>
              </h2>
              <div id="collapse{{ event.id }}" class="accordion-collapse collapse"
                   aria-labelledby="heading{{ event.id }}" data-bs-parent="#eventsAccordion">
                <div class="accordion-body pt-2">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small">Threat: {{ event.theme.name }}</span>
                    <a href="{% url 'view_event' event_id=event.id %}" class="btn btn-sm btn-outline-primary">
                      View Details
                    </a>
                  </div>

                  <h6 class="mt-3 mb-2">Sources ({{ event.sources.count }})</h6>
                  {% with sources=event.sources.all|slice:":3" %}
                  {% if sources %}
                    <div class="sources-container">
                      {% for source in sources %}
                      <div class="card mb-2 source-card" data-source-url="{% url 'source_detail' pk=source.id %}">
                        <div class="card-body py-2">
                          <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                              <i class="fas fa-file text-secondary me-2"></i>
                              <div>
                                <div class="fw-medium">{{ source.name }}</div>
                                <small class="text-muted">{{ source.source_date|date:"Y-m-d" }}</small>
                              </div>
                            </div>
                            <div>
                              {% if source.potential_impact == 'ESCALATING' %}
                                <span class="badge bg-danger" title="Escalating"><i class="fas fa-arrow-up"></i></span>
                              {% elif source.potential_impact == 'MAINTAINING' %}
                                <span class="badge bg-warning" title="Maintaining"><i class="fas fa-arrow-right"></i></span>
                              {% elif source.potential_impact == 'DECREASING' %}
                                <span class="badge bg-success" title="Decreasing"><i class="fas fa-arrow-down"></i></span>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      </div>
                      {% endfor %}
                      {% if event.sources.count > 3 %}
                      <div class="text-center mt-2">
                        <small class="text-muted">+ {{ event.sources.count|add:"-3" }} more sources</small>
                      </div>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="text-center py-2 text-muted">
                      <small>No sources added yet</small>
                    </div>
                  {% endif %}
                  {% endwith %}

                  <div class="mt-3 text-center">
                    <a href="{% url 'add_source' event_pk=event.id %}" class="btn btn-sm btn-outline-primary">
                      <i class="fas fa-plus me-1"></i> Add Source
                    </a>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>

          <!-- Paginación Events -->
          <div class="d-flex justify-content-between align-items-center mt-3" id="eventsPagerWrap">
            <div class="small text-muted" id="eventsCountText"></div>
            <nav>
              <ul class="pagination pagination-sm mb-0" id="eventsPagination"></ul>
            </nav>
          </div>

          {% if not events %}
          <div class="text-center p-4">
            <i class="fas fa-calendar-times fa-2x text-muted mb-2"></i>
            <p class="text-muted">No events found</p>
            <a href="{% url 'add_event_redirect' %}" class="btn btn-primary btn-sm">
              <i class="fas fa-plus me-1"></i> Add Event
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .accordion-button:not(.collapsed) { background-color:#f8f9fa; box-shadow: inset 0 -1px 0 rgba(0,0,0,.125); }
  .truncate { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .table-clickable tbody tr { cursor:pointer; }
  .table-fixed { table-layout:fixed; }

  .col-name { width: 42%; }
  .col-category { width: 22%; }
  .col-date { width: 18%; }
  .col-risk { width: 18%; }

  .event-item.hidden { display:none !important; }
  .event-item.highlight .accordion-button { background-color:#fff3cd !important; border-color:#ffeaa7 !important; }
  #eventsAccordion { max-height: 600px; overflow-y: auto; }

  .text-purple { color:#6f42c1; }
  table .badge { font-weight:600; }
  .card { box-shadow:0 0.125rem 0.25rem rgba(0,0,0,.075); }

  .sort-event.active { background-color:#6c757d; color:#fff; border-color:#6c757d; }

  .source-card { cursor:pointer; transition:all .2s ease; }
  .source-card:hover { transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,0.12); background-color:#f8f9fa; }

  /* Paginación compacta */
  #eventsPagination .page-link { padding: .25rem .5rem; }
</style>
{% endblock %}

{% block scripts %}
<script>
/* ===== Threats: DataTable ===== */
$(function () {
  const themesDT = $('#themesTable').DataTable({
    autoWidth: false,
    columnDefs: [
      { targets: 0, width: '42%', className: 'col-name' },
      { targets: 1, width: '22%', className: 'col-category' },
      { targets: 2, width: '18%', className: 'col-date' },
      { targets: 3, width: '18%', className: 'col-risk' }
    ],
    order: [[2, 'desc']],
    pageLength: 5,
    language: {
      emptyTable: 'No threats available',
      info: 'Showing _START_ to _END_ of _TOTAL_ threats',
      infoEmpty: 'Showing 0 to 0 of 0 threats',
      infoFiltered: '(filtered from _MAX_ total threats)',
      lengthMenu: 'Show _MENU_ threats',
      search: 'Search threats:',
      paginate: { first: 'First', last: 'Last', next: 'Next', previous: 'Previous' }
    }
  });

  $('#themesTable').on('click', 'tbody tr', function (e) {
    if ($(e.target).closest('a,button,.btn').length) return;
    const href = $(this).attr('data-href');
    if (href) window.location = href;
  });
});

/* ===== Events: búsqueda, orden y paginación ===== */
document.addEventListener('DOMContentLoaded', function () {
  const eventSearch = document.getElementById('eventSearch');
  const eventItems  = Array.from(document.querySelectorAll('.event-item'));
  const eventsAccordion = document.getElementById('eventsAccordion');
  const showSelect = document.getElementById('eventShowCount');
  const pager = document.getElementById('eventsPagination');
  const countText = document.getElementById('eventsCountText');

  let currentSort = 'name';
  let sortAscending = true;
  let currentPage = 1;

  function getPageSize() {
    const v = showSelect.value;
    return v === 'all' ? Infinity : parseInt(v, 10);
  }

  function visibleItems() {
    return eventItems.filter(el => !el.classList.contains('filtered-out'));
  }

  function renderPagination(total, pageSize) {
    // ocultar si all o sin necesidad
    if (!isFinite(pageSize) || total <= pageSize) {
      pager.innerHTML = '';
      countText.textContent = total ? `Showing 1–${Math.min(total, pageSize)} of ${total}` : 'No events';
      return;
    }
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    currentPage = Math.min(currentPage, totalPages);

    const makePage = (label, page, disabled=false, active=false) => (
      `<li class="page-item ${disabled?'disabled':''} ${active?'active':''}">
         <a class="page-link" href="#" data-page="${page}">${label}</a>
       </li>`
    );

    let html = '';
    html += makePage('«', currentPage-1, currentPage===1);
    for (let p=1; p<=totalPages; p++) {
      if (p===1 || p===totalPages || Math.abs(p-currentPage)<=1) {
        html += makePage(p, p, false, p===currentPage);
      } else if (Math.abs(p-currentPage)===2) {
        html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
      }
    }
    html += makePage('»', currentPage+1, currentPage===totalPages);
    pager.innerHTML = html;

    const start = (currentPage-1)*pageSize + 1;
    const end = Math.min(currentPage*pageSize, total);
    countText.textContent = `Showing ${start}–${end} of ${total}`;
  }

  function applyShowPage() {
    const pageSize = getPageSize();
    const vis = visibleItems();
    const total = vis.length;

    // toggle por página
    if (!isFinite(pageSize)) {
      vis.forEach(el => el.classList.remove('hidden'));
      renderPagination(total, pageSize);
      return;
    }
    const startIdx = (currentPage-1)*pageSize;
    const endIdx = startIdx + pageSize;

    vis.forEach((el, idx) => {
      if (idx >= startIdx && idx < endIdx) el.classList.remove('hidden');
      else el.classList.add('hidden');
    });

    renderPagination(total, pageSize);
  }

  function searchEvents() {
    const term = (eventSearch.value || '').toLowerCase().trim();
    eventItems.forEach(item => {
      const text = item.textContent.toLowerCase();
      const name = item.getAttribute('data-name') || '';
      const match = !term || name.includes(term) || text.includes(term);
      item.classList.toggle('filtered-out', !match);
      item.classList.toggle('highlight', !!term && match);
    });
    currentPage = 1;
    applyShowPage();
  }

  function sortEvents(sortBy, ascending) {
    const items = visibleItems().slice();
    items.sort((a, b) => {
      let av, bv;
      if (sortBy === 'name') {
        av = a.getAttribute('data-name') || '';
        bv = b.getAttribute('data-name') || '';
      } else if (sortBy === 'date') {
        av = a.getAttribute('data-date') || '00000000';
        bv = b.getAttribute('data-date') || '00000000';
      } else if (sortBy === 'risk') {
        const order = { critical: 0, high: 1, medium: 2, low: 3 };
        av = order[a.getAttribute('data-risk')] ?? 9;
        bv = order[b.getAttribute('data-risk')] ?? 9;
      } else {
        av = a.getAttribute('data-name') || '';
        bv = b.getAttribute('data-name') || '';
      }
      if (av < bv) return ascending ? -1 : 1;
      if (av > bv) return ascending ? 1 : -1;
      return 0;
    });
    items.forEach(it => eventsAccordion.appendChild(it));
    currentPage = 1;
    applyShowPage();
  }

  // listeners
  eventSearch.addEventListener('input', () => { searchEvents(); sortEvents(currentSort, sortAscending); });

  document.querySelectorAll('.sort-event').forEach(btn => {
    btn.addEventListener('click', function () {
      const sortBy = this.getAttribute('data-sort');
      if (sortBy === currentSort) sortAscending = !sortAscending;
      else { currentSort = sortBy; sortAscending = true; }
      document.querySelectorAll('.sort-event').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      sortEvents(currentSort, sortAscending);
    });
  });

  showSelect.addEventListener('change', () => {
    currentPage = 1;
    applyShowPage();
  });

  document.getElementById('eventsPagination').addEventListener('click', function(e){
    const a = e.target.closest('a.page-link');
    if (!a) return;
    e.preventDefault();
    const page = parseInt(a.dataset.page, 10);
    if (!isNaN(page)) {
      currentPage = Math.max(1, page);
      applyShowPage();
    }
  });

  // Inicial
  searchEvents();               // marca filtered-out según búsqueda (vacía)
  sortEvents(currentSort, true); // orden inicial por name asc
});

/* Source cards clickable */
document.addEventListener('DOMContentLoaded', function(){
  const cards = document.querySelectorAll('.source-card[data-source-url]');
  cards.forEach(card=>{
    card.addEventListener('click', (e)=>{
      if (e.target.closest('a, button, .badge, i')) return;
      const url = card.getAttribute('data-source-url');
      if (url) window.location.href = url;
    });
  });
});
</script>
{% endblock %}
