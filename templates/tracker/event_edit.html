{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <div class="card">
    <div class="card-header bg-primary text-white">
      <h4 class="m-0">
        <i class="fas fa-{% if creating %}plus-circle{% else %}edit{% endif %} me-2"></i>
        {% if creating %}Add New{% else %}Edit{% endif %} Event
        <span id="theme-title">{% if theme %}for {{ theme.name }}{% endif %}</span>
      </h4>
    </div>

    <div class="card-body">
      <form method="post" action="{% if creating %}{% url 'add_event' theme_id=theme.pk %}{% else %}{% url 'edit_event' pk=event.pk %}{% endif %}" id="event-form" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <!-- ===== Basic + Classification ===== -->
        <div class="row mb-4">
          <!-- Basic -->
          <div class="col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-header bg-light">
                <h5 class="m-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
              </div>
              <div class="card-body">
                <!-- Theme -->
                <div class="mb-3">
                  <label class="form-label" for="id_theme">Thread</label>
                  <select name="theme" id="id_theme" class="form-select" required>
                    {% for value, label in form.theme.field.choices %}
                      <option value="{{ value }}"
                              data-theme-name="{{ label }}"
                              {% if form.theme.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>
                        {{ label }}
                      </option>
                    {% endfor %}
                  </select>
                  {% if form.theme.errors %}<div class="invalid-feedback d-block">{{ form.theme.errors|join:", " }}</div>{% endif %}
                </div>

                <!-- Name -->
                <div class="mb-3">
                  <label class="form-label">
                    Name
                    <span class="text-muted float-end"><span id="name-char-count">0</span>/30</span>
                  </label>
                  <input type="text" name="name" class="form-control title-input"
                         maxlength="30" required
                         value="{{ form.name.value|default_if_none:'' }}"
                         placeholder="Enter event name"
                         oninput="updateCharCount(this)">
                  <div class="form-text text-muted">Maximum 30 characters allowed</div>
                  {% if form.name.errors %}<div class="invalid-feedback d-block">{{ form.name.errors|join:", " }}</div>{% endif %}
                </div>

                <!-- Date -->
                <div class="mb-1">
                  <label class="form-label" for="id_date_identified">Date Identified</label>
                  <input type="date" name="date_identified" id="id_date_identified" class="form-control"
                         value="{{ form.date_identified.value|date:'Y-m-d' }}" max="{% now 'Y-m-d' %}" required>
                  <div class="form-text text-muted">Date cannot be in the future</div>
                  {% if form.date_identified.errors %}<div class="invalid-feedback d-block">{{ form.date_identified.errors|join:", " }}</div>{% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Classification -->
          <div class="col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-header bg-light">
                <h5 class="m-0"><i class="fas fa-tags me-2"></i>Classification</h5>
              </div>
              <div class="card-body">
                <!-- Risk Rating (cards + hidden select) -->
                <div class="mb-3">
                  <label class="form-label">Risk Rating</label>

                  <!-- Select real (queda oculto pero es el que envÃ­a el valor) -->
                  <select name="risk_rating" class="form-select d-none" id="risk_select" required>
                    {% for value, label in form.risk_rating.field.choices %}
                      <option value="{{ value }}"
                              {% if form.risk_rating.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>
                        {{ label }}
                      </option>
                    {% endfor %}
                  </select>

                  <!-- Tarjetas compactas -->
                  <div class="row g-2 mt-1" id="risk_cards">
                    <div class="col-6 col-sm-3">
                      <button type="button" class="risk-card btn w-100 {% if form.risk_rating.value == 'LOW' %}selected{% endif %}" data-value="LOW" title="Low">
                        <div class="risk-icon risk-low"><i class="fas fa-check-circle"></i></div>
                        <div class="risk-label">Low</div>
                      </button>
                    </div>
                    <div class="col-6 col-sm-3">
                      <button type="button" class="risk-card btn w-100 {% if form.risk_rating.value == 'MEDIUM' %}selected{% endif %}" data-value="MEDIUM" title="Medium">
                        <div class="risk-icon risk-medium"><i class="fas fa-exclamation-circle"></i></div>
                        <div class="risk-label">Medium</div>
                      </button>
                    </div>
                    <div class="col-6 col-sm-3">
                      <button type="button" class="risk-card btn w-100 {% if form.risk_rating.value == 'HIGH' %}selected{% endif %}" data-value="HIGH" title="High">
                        <div class="risk-icon risk-high"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="risk-label">High</div>
                      </button>
                    </div>
                    <div class="col-6 col-sm-3">
                      <button type="button" class="risk-card btn w-100 {% if form.risk_rating.value == 'CRITICAL' %}selected{% endif %}" data-value="CRITICAL" title="Critical">
                        <div class="risk-icon risk-critical"><i class="fas fa-skull-crossbones"></i></div>
                        <div class="risk-label">Critical</div>
                      </button>
                    </div>
                  </div>

                  {% if form.risk_rating.errors %}<div class="invalid-feedback d-block">{{ form.risk_rating.errors|join:", " }}</div>{% endif %}
                </div>

                <!-- Status -->
                <div class="mb-3">
                  <label class="form-label" for="id_status">Status</label>
                  <select name="status" id="id_status" class="form-select" required>
                    {% for value, label in form.status.field.choices %}
                      <option value="{{ value }}" {% if form.status.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                  {% if form.status.errors %}<div class="invalid-feedback d-block">{{ form.status.errors|join:", " }}</div>{% endif %}
                </div>

                <!-- Control in place -->
                <div class="form-check form-switch d-flex align-items-center mt-2">
                  <input type="checkbox" class="form-check-input me-2" id="id_control_in_place" name="control_in_place" {% if form.control_in_place.value %}checked{% endif %}>
                  <label class="form-check-label" for="id_control_in_place">Control in Place</label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== Impacted Business Lines ===== -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-light">
            <h5 class="m-0"><i class="fas fa-building me-2"></i>Impacted Business Lines</h5>
          </div>
          <div class="card-body">
            <div class="business-lines-container">
              {% for checkbox in form.impacted_lines %}
                {% if checkbox.choice_label == "All" %}
                  <div class="form-check form-check-inline">
                    {{ checkbox.tag }} <label class="form-check-label" for="{{ checkbox.id_for_label }}">All</label>
                  </div>
                {% endif %}
              {% endfor %}
              {% for checkbox in form.impacted_lines %}
                {% if checkbox.choice_label != "All" %}
                  <div class="form-check form-check-inline">
                    {{ checkbox.tag }} <label class="form-check-label" for="{{ checkbox.id_for_label }}">{{ checkbox.choice_label }}</label>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- ===== Risk Taxonomy (Level 1/2/3) ===== -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-light">
            <h5 class="m-0"><i class="fas fa-sitemap me-2"></i>Risk Taxonomy</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <!-- Level 1 -->
              <div class="col-md-4">
                <label class="form-label">Risk Taxonomy Level 1 <span class="text-danger">*</span></label>
                <div class="taxonomy-container scroll-container" id="taxonomy-lv1-container">
                  {% for lv1 in RISK_TAXONOMY_LV1 %}
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox"
                             name="risk_taxonomy_lv1" value="{{ lv1.0 }}"
                             id="lv1-{{ lv1.0|slugify }}"
                             {% if lv1.0 in form.risk_taxonomy_lv1.value %}checked{% endif %}>
                      <label class="form-check-label" for="lv1-{{ lv1.0|slugify }}">{{ lv1.1 }}</label>
                    </div>
                  {% endfor %}
                </div>
                <div id="lv1-error" class="invalid-feedback" style="display:none;">Please select at least one Level 1 option</div>
              </div>

              <!-- Level 2 -->
              <div class="col-md-4" id="lv2-container" style="display:none;">
                <label class="form-label">Risk Taxonomy Level 2 <span class="text-danger">*</span></label>
                <div class="taxonomy-container scroll-container" id="lv2-options"></div>
                <div id="lv2-error" class="invalid-feedback" style="display:none;">Please select at least one Level 2 option</div>
              </div>

              <!-- Level 3 -->
              <div class="col-md-4" id="lv3-container" style="display:none;">
                <label class="form-label">Risk Taxonomy Level 3 <span class="text-danger">*</span></label>
                <div class="taxonomy-container scroll-container" id="lv3-options"></div>
                <div id="lv3-error" class="invalid-feedback" style="display:none;">Please select at least one Level 3 option</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== Description ===== -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-light">
            <h5 class="m-0"><i class="fas fa-align-left me-2"></i>Description</h5>
          </div>
          <div class="card-body">
            <label class="form-label" for="id_description">Event Description</label>
            <textarea name="description" id="id_description" class="form-control full-width" rows="3" required placeholder="Add a description to the event">{{ form.description.value|default_if_none:'' }}</textarea>
            {% if form.description.errors %}<div class="invalid-feedback d-block">{{ form.description.errors|join:", " }}</div>{% endif %}
          </div>
        </div>

        <!-- ===== Actions ===== -->
        <div class="d-flex justify-content-between">
          <a href="{% if theme %}{% url 'view_theme' pk=theme.id %}{% else %}{% url 'dashboard' %}{% endif %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Cancel
          </a>
          <button type="submit" class="btn btn-primary" id="submit-btn">
            <i class="fas fa-save me-1"></i> Save Event
          </button>
        </div>
      </form>
    </div>
  </div>

  {% if form.errors %}
  <div class="alert alert-danger mt-3">
    <strong>Error!</strong> Please fix the following issues:
    <ul class="mb-0">
      {% for field, errors in form.errors.items %}
        {% for error in errors %}
          <li>
            {% if field == "risk_taxonomy_lv2" %}Level 2: {{ error }}
            {% elif field == "risk_taxonomy_lv3" %}Level 3: {{ error }}
            {% else %}{{ field|title }}: {{ error }}{% endif %}
          </li>
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
/* ---------- Name counter ---------- */
function updateCharCount(input){
  const n = (input?.value || '').length;
  const max = Number(input?.getAttribute('maxlength') || 30);
  const el = document.getElementById('name-char-count');
  if (!el) return;
  el.textContent = n;
  el.classList.remove('text-muted','text-warning','text-danger');
  if (n >= max) el.classList.add('text-danger');
  else if (n > max*0.8) el.classList.add('text-warning');
  else el.classList.add('text-muted');
}
document.addEventListener('DOMContentLoaded', () => {
  const nameInput = document.querySelector('input[name="name"]');
  if (nameInput) updateCharCount(nameInput);

/* ---------- Theme title live ---------- */
  const themeSel = document.getElementById('id_theme');
  themeSel?.addEventListener('change', () => {
    const opt = themeSel.options[themeSel.selectedIndex];
    const h = document.getElementById('theme-title');
    h.textContent = opt && opt.dataset.themeName ? ('for ' + opt.dataset.themeName) : '';
  });

/* ---------- Risk cards ---------- */
  const riskSelect = document.getElementById('risk_select');
  const cards = document.querySelectorAll('#risk_cards .risk-card');
  const selectCard = (val) => {
    cards.forEach(c => c.classList.toggle('selected', c.dataset.value === val));
    riskSelect.value = val;
  };
  cards.forEach(c => c.addEventListener('click', () => selectCard(c.dataset.value)));
  if (riskSelect.value) selectCard(riskSelect.value);

/* ---------- Business lines "All" ---------- */
  const allCb = document.querySelector('input[name="impacted_lines"][value="All"]');
  if (allCb){
    const others = document.querySelectorAll('input[name="impacted_lines"]:not([value="All"])');
    const syncAll = () => {
      const allChecked = [...others].every(cb => cb.checked);
      if (allChecked) { allCb.checked = true; others.forEach(cb => cb.disabled = true); }
      else { others.forEach(cb => cb.disabled = false); }
    };
    allCb.addEventListener('change', () => {
      others.forEach(cb => { cb.checked = allCb.checked; cb.disabled = allCb.checked; });
    });
    others.forEach(cb => cb.addEventListener('change', () => { if (cb.checked) allCb.checked = false; syncAll(); }));
    if (allCb.checked) { others.forEach(cb => { cb.checked = true; cb.disabled = true; }); }
    else syncAll();
  }

/* ---------- Taxonomy (LV1 â LV2 â LV3) ---------- */
  let taxonomy = { hierarchical: [], flat: {} };
  try { taxonomy = JSON.parse('{{ taxonomy_json|escapejs }}'); } catch(e) { console.warn('taxonomy_json parse error', e); }

  // Selecciones persistentes en memoria
  const sel = { lv1: [], lv2: [], lv3: [] };

  // Mapa de padres para depurar al cambiar niveles
  const parentOfLv2 = {};
  const parentOfLv3 = {};

  (taxonomy.hierarchical || []).forEach(l1 => {
    (l1.children || []).forEach(l2 => {
      parentOfLv2[l2.key] = l1.key;
      (l2.children || []).forEach(l3 => {
        parentOfLv3[l3.key] = l2.key;
      });
    });
  });

  // Cargar selecciÃ³n inicial desde taxonomy_json (ediciÃ³n)
  (taxonomy.hierarchical || []).forEach(l1 => {
    if (l1.selected) sel.lv1.push(l1.key);
    (l1.children || []).forEach(l2 => {
      if (l2.selected) sel.lv2.push(l2.key);
      (l2.children || []).forEach(l3 => {
        if (l3.selected) sel.lv3.push(l3.key);
      });
    });
  });

  // DOM refs
  const lv1Box = document.getElementById('taxonomy-lv1-container');
  const lv2Wrap = document.getElementById('lv2-container');
  const lv3Wrap = document.getElementById('lv3-container');
  const lv2Options = document.getElementById('lv2-options');
  const lv3Options = document.getElementById('lv3-options');

  // Util
  const genId = (t) => String(t).toLowerCase().replace(/[^a-z0-9]+/g,'-');

  // Lectores desde DOM (LV1 se lee del DOM; LV2/LV3 se mantienen en sel.*)
  function readLv1(){
    sel.lv1 = [...document.querySelectorAll('input[name="risk_taxonomy_lv1"]:checked')].map(x => x.value);
  }

  // Depurar selecciones de niveles inferiores cuando cambian superiores
  function pruneAfterLv1Change(){
    // Mantener solo LV2 cuyos padres LV1 sigan marcados
    sel.lv2 = sel.lv2.filter(k2 => sel.lv1.includes(parentOfLv2[k2]));
    // Mantener solo LV3 cuyos padres LV2 sigan en sel.lv2
    sel.lv3 = sel.lv3.filter(k3 => sel.lv2.includes(parentOfLv3[k3]));
  }
  function pruneAfterLv2Change(){
    sel.lv3 = sel.lv3.filter(k3 => sel.lv2.includes(parentOfLv3[k3]));
  }

  function buildLv2(){
    readLv1();
    pruneAfterLv1Change();

    if (!sel.lv1.length){
      lv2Options.innerHTML = '';
      lv2Wrap.style.display = 'none';
      lv3Options.innerHTML = '';
      lv3Wrap.style.display = 'none';
      return;
    }

    // Generar LV2 solo para los LV1 actualmente marcados
    let html = '';
    sel.lv1.forEach(k1 => {
      const n1 = (taxonomy.hierarchical || []).find(x => x.key === k1);
      if (!n1) return;
      html += `<div class="taxonomy-group mb-2">`;
      html += `<div class="fw-bold small text-muted">${n1.label}</div>`;
      (n1.children || []).forEach(l2 => {
        const checked = sel.lv2.includes(l2.key) ? 'checked' : '';
        html += `
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="risk_taxonomy_lv2"
                   value="${l2.key}" id="lv2-${genId(l2.key)}" ${checked}>
            <label class="form-check-label" for="lv2-${genId(l2.key)}">${l2.label}</label>
          </div>`;
      });
      html += `</div>`;
    });
    lv2Options.innerHTML = html;
    lv2Wrap.style.display = 'block';

    // Listeners LV2: actualizar sel.lv2 y LV3 dependientes
    document.querySelectorAll('input[name="risk_taxonomy_lv2"]').forEach(el => {
      el.addEventListener('change', () => {
        if (el.checked) {
          if (!sel.lv2.includes(el.value)) sel.lv2.push(el.value);
        } else {
          sel.lv2 = sel.lv2.filter(v => v !== el.value);
          // si quitas un LV2, quita todos sus LV3
          sel.lv3 = sel.lv3.filter(k3 => parentOfLv3[k3] !== el.value);
        }
        buildLv3();
      });
    });

    buildLv3();
    setTimeout(() => lv2Wrap.scrollIntoView({behavior:'smooth', block:'center'}), 50);
  }

  function buildLv3(){
    pruneAfterLv2Change();

    if (!sel.lv2.length){
      lv3Options.innerHTML = '';
      lv3Wrap.style.display = 'none';
      return;
    }

    let html = '';
    sel.lv2.forEach(k2 => {
      // Buscar el nodo LV2 en el Ã¡rbol para renderizar sus hijos
      let node2 = null;
      for (const n1 of (taxonomy.hierarchical || [])){
        const f = (n1.children || []).find(c => c.key === k2);
        if (f) { node2 = f; break; }
      }
      if (!node2 || !(node2.children || []).length) return;

      html += `<div class="taxonomy-group mb-2">`;
      html += `<div class="fw-bold small text-muted">${node2.label}</div>`;
      (node2.children || []).forEach(l3 => {
        const checked = sel.lv3.includes(l3.key) ? 'checked' : '';
        html += `
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="risk_taxonomy_lv3"
                   value="${l3.key}" id="lv3-${genId(l3.key)}" ${checked}>
            <label class="form-check-label" for="lv3-${genId(l3.key)}">${l3.label}</label>
          </div>`;
      });
      html += `</div>`;
    });
    lv3Options.innerHTML = html;
    lv3Wrap.style.display = 'block';

    // Listeners LV3: actualizar sel.lv3
    document.querySelectorAll('input[name="risk_taxonomy_lv3"]').forEach(el => {
      el.addEventListener('change', () => {
        if (el.checked) {
          if (!sel.lv3.includes(el.value)) sel.lv3.push(el.value);
        } else {
          sel.lv3 = sel.lv3.filter(v => v !== el.value);
        }
      });
    });

    setTimeout(() => lv3Wrap.scrollIntoView({behavior:'smooth', block:'center'}), 50);
  }

  // Listeners LV1
  lv1Box.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', () => {
      // Actualizar sel.lv1 desde DOM y reconstruir niveles manteniendo selecciones vÃ¡lidas
      buildLv2();
    });
  });

  // Bootstrap inicial
  (function bootstrapTaxonomy(){
    // Si el usuario ya tenÃ­a LV1 marcados en el DOM, Ãºsalos como fuente de verdad
    const lv1FromDom = [...document.querySelectorAll('input[name="risk_taxonomy_lv1"]:checked')].map(x => x.value);
    if (lv1FromDom.length) sel.lv1 = lv1FromDom;
    buildLv2();
  })();

/* ---------- Submit validation ---------- */
  document.getElementById('submit-btn').addEventListener('click', function(e){
    let ok = true;

    // basic requireds
    ['id_theme','id_date_identified','id_status','risk_select','id_description'].forEach(id => {
      const el = document.getElementById(id) || document.querySelector(`[name="${id}"]`);
      if (!el || !el.value) { ok = false; el?.classList.add('is-invalid'); }
      else el.classList.remove('is-invalid');
    });

    // date not future
    const d = document.getElementById('id_date_identified');
    if (d && d.value){
      const selD = new Date(d.value);
      const t = new Date(); t.setHours(0,0,0,0);
      if (selD > t){ ok = false; d.classList.add('is-invalid'); }
    }

    // taxonomy required
    if (![...document.querySelectorAll('input[name="risk_taxonomy_lv1"]:checked')].length){
      ok = false; document.getElementById('lv1-error').style.display='block';
    } else document.getElementById('lv1-error').style.display='none';

    if (lv2Wrap.style.display !== 'none' &&
        ![...document.querySelectorAll('input[name="risk_taxonomy_lv2"]:checked')].length){
      ok = false; document.getElementById('lv2-error').style.display='block';
    } else document.getElementById('lv2-error').style.display='none';

    if (lv3Wrap.style.display !== 'none' &&
        ![...document.querySelectorAll('input[name="risk_taxonomy_lv3"]:checked')].length){
      ok = false; document.getElementById('lv3-error').style.display='block';
    } else document.getElementById('lv3-error').style.display='none';

    if (!ok) { e.preventDefault(); (document.querySelector('.is-invalid') || document.querySelector('.invalid-feedback[style*="block"]'))?.scrollIntoView({behavior:'smooth', block:'center'}); }
  });
});
</script>

<style>
/* Basics */
.form-control,.form-select{min-height:38px}
.title-input{font-size:1.15rem;font-weight:500}
.card{box-shadow:0 .125rem .25rem rgba(0,0,0,.075);margin-bottom:1rem}
.card-header{padding:.75rem 1rem}
.full-width{width:100%}
.invalid-feedback{display:block}

/* Risk cards */
#risk_cards .risk-card{
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:.35rem; border:2px solid #dee2e6; background:#fff; border-radius:.8rem;
  padding:.6rem .4rem; transition:.15s; height:100%;
}
#risk_cards .risk-card:hover{ transform:translateY(-2px); box-shadow:0 .25rem .5rem rgba(0,0,0,.06); }
#risk_cards .risk-card.selected{ border-color:#0d6efd; box-shadow:0 0 0 .15rem rgba(13,110,253,.25); }
.risk-icon{font-size:1.15rem}
.risk-low{color:#28a745}
.risk-medium{color:#ffc107}
.risk-high{color:#fd7e14}
.risk-critical{color:#dc3545}
.risk-label{font-weight:600;font-size:.85rem}

/* Taxonomy */
.taxonomy-container{
  max-height:300px; overflow-y:auto; padding:10px; background:#f8f9fa; border-radius:5px; border:1px solid #dee2e6;
}
.scroll-container{scroll-behavior:smooth}
.scroll-container::-webkit-scrollbar{width:10px}
.scroll-container::-webkit-scrollbar-track{background:#f1f1f1;border-radius:4px}
.scroll-container::-webkit-scrollbar-thumb{background:#a8a8a8;border-radius:4px}
.scroll-container::-webkit-scrollbar-thumb:hover{background:#888}
.taxonomy-group{border-left:3px solid #dee2e6; padding-left:10px; margin-bottom:10px}
.taxonomy-group .text-muted{padding-bottom:3px; border-bottom:1px dashed #dee2e6; margin-bottom:5px}

/* Business lines */
.business-lines-container{padding:12px;background:#f8f9fa;border-radius:6px}
</style>
{% endblock %}
