{% extends "base.html" %}
{% load static %}

{% block content %}
<div id="add-source-screen" class="container mt-4">
  <div class="card">
    <div class="card-header bg-primary text-white">
      <h4 class="m-0">
        <i class="fas fa-plus-circle me-2"></i>
        Add Source{% if event %} for {{ event.name }}{% endif %}
      </h4>
    </div>

    <div class="card-body">
      <form method="post" enctype="multipart/form-data" id="add-source-form" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="row g-4 mb-2">
          <!-- Basic -->
          <div class="col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-header bg-light">
                <h5 class="m-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label" for="id_event">Event</label>
                  {{ form.event }}
                  {% if form.event.errors %}<div class="invalid-feedback d-block">{{ form.event.errors|join:", " }}</div>{% endif %}
                </div>

                <div class="mb-3">
                  <label class="form-label">
                    Name
                    <span class="text-muted float-end"><span id="nmCnt">0</span>/30</span>
                  </label>
                  {{ form.name }}
                  <div class="form-text text-muted">Maximum 30 characters allowed.</div>
                  {% if form.name.errors %}<div class="invalid-feedback d-block">{{ form.name.errors|join:", " }}</div>{% endif %}
                </div>

                <div class="mb-1">
                  <label class="form-label" for="id_source_date">Date</label>
                  {# El widget de Django ya es type="date". Lo dejamos y solo regulamos con JS. #}
                  {{ form.source_date }}
                  <div class="form-text text-muted">Pick a date (today or earlier).</div>
                  {% if form.source_date.errors %}<div class="invalid-feedback d-block">{{ form.source_date.errors|join:", " }}</div>{% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Attachments (Links & Files) -->
          <div class="col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-header bg-light">
                <h5 class="m-0"><i class="fas fa-paperclip me-2"></i>Links & Files</h5>
              </div>
              <div class="card-body">
                <!-- Link options -->
                <div class="mb-4">
                  <h6 class="text-muted"><i class="fas fa-link me-2"></i>Link options</h6>

                  <label class="form-label">Main link (optional)</label>
                  {{ form.link_or_file }}
                  <div class="form-text">Use http(s):// or mailto:user@domain.</div>
                  <div id="url-err" class="invalid-feedback" style="display:none;">
                    Enter a valid URL (http/https) or mailto:.
                  </div>
                  {% if form.link_or_file.errors %}<div class="invalid-feedback d-block">{{ form.link_or_file.errors|join:", " }}</div>{% endif %}

                  <label class="form-label mt-3">Additional links</label>
                  <div id="extra-links">
                    <div class="input-group mb-2">
                      <input type="text" name="extra_links" class="form-control" placeholder="http(s):// or mailto:" />
                      <button type="button" class="btn btn-outline-secondary" onclick="addLink()" title="Add link">+</button>
                    </div>
                  </div>
                  <div class="form-text">You can add multiple. Remove a row with the “x”.</div>
                </div>

                <!-- File options -->
                <div>
                  <h6 class="text-muted"><i class="fas fa-file-upload me-2"></i>File options</h6>

                  <label class="form-label">Main file (optional)</label>
                  <input type="file" name="file_upload" class="form-control" id="id_file_upload"
                         accept=".pdf,.doc,.docx,.eml,.msg">
                  {% if form.file_upload.errors %}<div class="invalid-feedback d-block">{{ form.file_upload.errors|join:", " }}</div>{% endif %}

                  <!-- Additional files -->
                  <div class="mt-3">
                    <label class="form-label">Additional files</label>

                    <div id="extra-files-container">
                      <!-- initial row -->
                      <div class="input-group mb-2 extra-file-row">
                        <input type="file"
                               name="extra_files"
                               class="form-control"
                               accept=".pdf,.doc,.docx,.eml,.msg">
                        <button type="button" class="btn btn-outline-danger" onclick="removeExtraFileRow(this)" title="Remove">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </div>

                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addExtraFileRow()" title="Add file">
                      <i class="fas fa-plus"></i> Add another file
                    </button>

                    <div class="form-text">You can upload multiple files (.pdf, .doc, .docx, .eml, .msg).</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Summary -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-light">
            <h5 class="m-0"><i class="fas fa-align-left me-2"></i>Summary</h5>
          </div>
          <div class="card-body">
            {{ form.summary }}
            <div class="invalid-feedback d-block" id="sum-dup" style="display:none;">
              Summary must be different from existing ones for this event.
            </div>
            <div class="form-text">Soft check only — you can still save.</div>
            {% if form.summary.errors %}<div class="invalid-feedback d-block">{{ form.summary.errors|join:", " }}</div>{% endif %}
          </div>
        </div>

        <!-- Impact -->
        <div class="row g-4 mb-4">
          <div class="col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-header bg-light">
                <h5 class="m-0"><i class="fas fa-bolt me-2"></i>Potential Impact</h5>
              </div>
              <div class="card-body">
                <div class="btn-group" role="group" aria-label="Potential Impact">
                  <input type="radio" class="btn-check" name="pi" id="piEsc" autocomplete="off">
                  <label class="btn btn-outline-danger" for="piEsc"><i class="fas fa-arrow-up me-1"></i> Escalating</label>

                  <input type="radio" class="btn-check" name="pi" id="piMain" autocomplete="off">
                  <label class="btn btn-outline-warning" for="piMain"><i class="fas fa-arrow-right me-1"></i> Maintaining</label>

                  <input type="radio" class="btn-check" name="pi" id="piDec" autocomplete="off">
                  <label class="btn btn-outline-success" for="piDec"><i class="fas fa-arrow-down me-1"></i> Decreasing</label>
                </div>

                <div class="d-none">{{ form.potential_impact }}</div>
                {% if form.potential_impact.errors %}<div class="invalid-feedback d-block">{{ form.potential_impact.errors|join:", " }}</div>{% endif %}
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-header bg-light">
                <h5 class="m-0"><i class="fas fa-sticky-note me-2"></i>Impact Notes</h5>
              </div>
              <div class="card-body">
                {{ form.potential_impact_notes }}
                {% if form.potential_impact_notes.errors %}<div class="invalid-feedback d-block">{{ form.potential_impact_notes.errors|join:", " }}</div>{% endif %}
              </div>
            </div>
          </div>
        </div>

        {{ form.source_type }} <!-- hidden -->

        <div class="d-flex justify-content-between">
          <a href="{{ cancel_url|default:'#' }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Cancel
          </a>
          <button class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Save
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{# === Estilos scopeados a esta pantalla === #}
<style>
  #add-source-screen .form-control,
  #add-source-screen .form-select{min-height:44px}
  #add-source-screen .card{box-shadow:0 .125rem .45rem rgba(0,0,0,.08);border-radius:.75rem}
  #add-source-screen .card-header{padding:.75rem 1rem}
  #add-source-screen .form-text{font-size:.88rem}

  /* Inputs más legibles */
  #add-source-screen input[type="text"],
  #add-source-screen input[type="url"]{font-size:1rem}

  /* Textareas grandes y cómodas */
  #add-source-screen textarea#id_summary{
    min-height: 220px;
    font-size: 1rem;
    line-height: 1.45;
  }
  #add-source-screen textarea#id_potential_impact_notes{
    min-height: 160px;
    font-size: 1rem;
    line-height: 1.45;
  }

  /* Botones radio como pills activas */
  #add-source-screen .btn-check:checked + .btn{
    color:#fff !important;
  }
  #add-source-screen #piEsc.btn-check:checked + label.btn{background-color:#dc3545;border-color:#dc3545;}
  #add-source-screen #piMain.btn-check:checked + label.btn{background-color:#ffc107;border-color:#ffc107;color:#212529 !important;}
  #add-source-screen #piDec.btn-check:checked + label.btn{background-color:#198754;border-color:#198754;}
</style>

{# Pasamos una bandera para limpiar la fecha SOLO en GET/primera carga #}
<script>
  const FORCE_EMPTY_DATE = {% if not form.errors and request.method != 'POST' %}true{% else %}false{% endif %};
</script>

<script>
  // name counter + maxlength (UI)
  (function(){
    const i=document.querySelector('input[name="name"]'), c=document.getElementById('nmCnt');
    if(i){ i.setAttribute('maxlength','30'); i.classList.add('title-input'); }
    function u(){ c.textContent=(i?.value||'').length; }
    i&&i.addEventListener('input',u); u();
  })();

  // date: max hoy, sin futuro; requerido y vacío en primera carga
  (function(){
    const d=document.getElementById('id_source_date'); if(!d) return;
    const t=new Date(), p=n=>String(n).padStart(2,'0');
    d.max = `${t.getFullYear()}-${p(t.getMonth()+1)}-${p(t.getDate())}`;
    d.required = true;

    // Deja el campo en blanco en la primera carga (no POST/no errores)
    if(FORCE_EMPTY_DATE){ try{ d.value = ''; }catch(e){} }

    // Sugerencia visual
    if(!d.getAttribute('placeholder')) d.setAttribute('placeholder','Select a date…');
  })();

  // potential impact (buttons -> hidden select)
  (function(){
    const sel=document.getElementById('id_potential_impact')||document.querySelector('select[name="potential_impact"]');
    const map={piEsc:"ESCALATING",piMain:"MAINTAINING",piDec:"DECREASING"};
    function pick(v){
      if(!sel) return;
      sel.value=v||"";
      ["piEsc","piMain","piDec"].forEach(id=>{ const r=document.getElementById(id); if(r) r.checked=(map[id]===v); });
    }
    pick(sel?.value);
    ["piEsc","piMain","piDec"].forEach(id=>{
      const el=document.getElementById(id); if(!el) return;
      el.addEventListener("change",()=>pick(map[id]));
    });
  })();

  // Mejorar textareas: placeholder si no viene desde el form
  (function(){
    const s=document.getElementById('id_summary');
    if(s && !s.placeholder){ s.placeholder = 'Concise summary of the source content…'; }
    const n=document.getElementById('id_potential_impact_notes');
    if(n && !n.placeholder){ n.placeholder = 'Context, rationale, affected LOBs, uncertainties…'; }
  })();

  // dynamic links
  function addLink(){
    const cont=document.getElementById('extra-links');
    const row=document.createElement('div'); row.className='input-group mb-2';
    row.innerHTML=`
      <input type="text" name="extra_links" class="form-control" placeholder="http(s):// or mailto:" />
      <button type="button" class="btn btn-outline-danger" title="Remove" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
    `;
    cont.appendChild(row);
  }

  // Additional files: multiple rows you can remove
  function addExtraFileRow(){
    const wrap = document.getElementById('extra-files-container');
    const row = document.createElement('div');
    row.className = 'input-group mb-2 extra-file-row';
    row.innerHTML = `
      <input type="file" name="extra_files" class="form-control" accept=".pdf,.doc,.docx,.eml,.msg">
      <button type="button" class="btn btn-outline-danger" onclick="removeExtraFileRow(this)" title="Remove">
        <i class="fas fa-times"></i>
      </button>
    `;
    wrap.appendChild(row);
  }
  function removeExtraFileRow(btn){
    const row = btn.closest('.extra-file-row');
    if(!row) return;
    const wrap = document.getElementById('extra-files-container');
    if(wrap.querySelectorAll('.extra-file-row').length === 1){
      const input = row.querySelector('input[type="file"]');
      if(input) input.value = '';
      return;
    }
    row.remove();
  }

  // URL validation (main + additional links)
  (function(){
    function isValidUrl(v){
      if(!v) return true; // empty is allowed
      v=v.trim();
      if(v.startsWith('mailto:')) return v.length>7 && v.includes('@');
      try{ const u=new URL(v); return ['http:','https:'].includes(u.protocol); }catch{ return false; }
    }
    const form=document.getElementById('add-source-form');
    form.addEventListener('submit', (e)=>{
      let ok=true;
      const main=document.getElementById('id_link_or_file');
      const urlErr=document.getElementById('url-err');
      if(main && main.value && !isValidUrl(main.value)){
        ok=false; urlErr.style.display='block'; main.classList.add('is-invalid');
      }else{
        urlErr.style.display='none'; main?.classList.remove('is-invalid');
      }
      document.querySelectorAll('input[name="extra_links"]').forEach(inp=>{
        if(inp.value && !isValidUrl(inp.value)){ ok=false; inp.classList.add('is-invalid'); }
        else { inp.classList.remove('is-invalid'); }
      });
      if(!ok){
        e.preventDefault();
        (document.querySelector('.is-invalid')||urlErr)?.scrollIntoView({behavior:'smooth', block:'center'});
      }
    });
  })();

  // soft duplicate-summary detection
  const existingSummaries = {{ existing_summaries_json|safe }};
  (function(){
    const el=document.getElementById('id_summary');
    const area=document.getElementById('sum-dup');
    function norm(s){ return String(s||'').trim().toLowerCase().replace(/\s+/g,' '); }
    el && el.addEventListener('blur', ()=>{
      const v=norm(el.value);
      if(v && (existingSummaries||[]).map(norm).includes(v)) area.style.display='block';
      else area.style.display='none';
    });
  })();
</script>
{% endblock %}
