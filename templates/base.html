{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fiserv Threat Landscape</title>

  <!-- Icons / Bootstrap -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- DataTables 1.11.5 (Bootstrap 5 skin) -->
  <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
  <!-- DataTables Select 1.3.4 (compatible con 1.11.x) -->
  <link href="https://cdn.datatables.net/select/1.3.4/css/select.bootstrap5.min.css" rel="stylesheet" />

  <style>
    .sidebar { min-height: 100vh; background-color: #f8f9fa; }
    .main-content { padding: 20px; }
    .nav-link.btn-link { text-align: left; }
    .nav-link.active { font-weight: 600; }
    .hover-shadow { transition: box-shadow .2s ease; }
    .hover-shadow:hover { box-shadow: 0 .5rem 1rem rgba(0,0,0,.1); }
    .bg-orange,
    .badge-orange {
      background-color: #fd7e14 !important;
      color: #fff !important;
    }
  </style>
  {% block head_extra %}{% endblock %}
</head>
<body>
  {% with url_name=request.resolver_match.url_name %}
  <div class="container-fluid">
    <div class="row">
      <!-- SIDEBAR -->
      <div class="col-md-2 sidebar p-3">
        <h4 class="mb-3">Fiserv Threat Landscape</h4>
        <hr />
        <ul class="nav flex-column">

          <!-- Dashboard -->
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'dashboard' %}active{% endif %}"
               href="{% url 'dashboard' %}">
              <i class="fas fa-gauge me-1"></i> Dashboard
            </a>
          </li>

          <!-- Solo admins (staff o superuser): crear Threat/Event/Source -->
          {% if user.is_authenticated %}
            {% if user.is_superuser or user.is_staff %}
              <li class="nav-item">
                <a class="nav-link {% if url_name == 'add_theme' %}active{% endif %}"
                   href="{% url 'add_theme' %}">
                  <i class="fas fa-plus-circle me-1"></i> Add Threat
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if url_name == 'add_event' or url_name == 'add_event_redirect' %}active{% endif %}"
                   href="{% url 'add_event_redirect' %}">
                  <i class="fas fa-plus-circle me-1"></i> Add Event
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if url_name == 'add_source' or url_name == 'add_source_redirect' %}active{% endif %}"
                   href="{% url 'add_source_redirect' %}">
                  <i class="fas fa-plus-circle me-1"></i> Add Source
                </a>
              </li>
            {% endif %}
          {% endif %}

          <!-- Auth -->
          <li class="nav-item mt-2">
            {% if user.is_authenticated %}
              {% if user.is_superuser %}
                <a class="nav-link {% if url_name == 'register' %}active{% endif %}"
                   href="{% url 'register' %}">
                  <i class="fas fa-user-plus me-1"></i> Create User
                </a>
              {% endif %}

              <form action="{% url 'logout' %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="nav-link btn btn-link" style="border:none; background:none; cursor:pointer;">
                  <i class="fas fa-sign-out-alt me-1"></i> Logout
                </button>
              </form>
            {% else %}
              <a class="nav-link {% if url_name == 'login' %}active{% endif %}"
                 href="{% url 'login' %}?next={{ request.get_full_path|urlencode }}">
                <i class="fas fa-sign-in-alt me-1"></i> Login
              </a>
              {# En Opción C no mostramos Register al público #}
            {% endif %}
          </li>
        </ul>
      </div>

      <!-- CONTENIDO -->
      <div class="col-md-10 main-content">
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-3">
              <div class="d-flex align-items-center">
                <i class="fas
                  {% if 'success' in message.tags %} fa-check-circle
                  {% elif 'error' in message.tags %} fa-exclamation-circle
                  {% elif 'warning' in message.tags %} fa-exclamation-triangle
                  {% else %} fa-info-circle {% endif %} me-2"></i>
                <span>{{ message }}</span>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            </div>
          {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}
      </div>
    </div>
  </div>
  {% endwith %}

  <!-- JS base -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- DataTables 1.11.5 -->
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <!-- DataTables Select 1.3.4 -->
  <script src="https://cdn.datatables.net/select/1.3.4/js/dataTables.select.min.js"></script>

  <!-- Tooltips bootstrap global -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el) })
    });
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
